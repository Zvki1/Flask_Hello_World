name: AperÃ§u Temporaire

on: [push]

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
    - name: Cloner le dÃ©pÃ´t
      uses: actions/checkout@v3

    - name: Installer Ngrok
      run: |
        curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update && sudo apt install ngrok

    - name: Configurer Ngrok avec l'authtoken
      run: ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Construire lâ€™image Docker
      run: docker build -t flask-ngrok .

    - name: Lancer le conteneur Flask
      run: |
        docker run -d -p 5000:5000 --name flask-app flask-ngrok
        echo "ğŸ•’ Attente que Flask dÃ©marre..."
        for i in {1..10}; do
          sleep 2
          if curl -s http://localhost:5000 > /dev/null; then
            echo "âœ… Serveur Flask prÃªt"
            break
          fi
        done

    - name: Lancer Ngrok et rÃ©cupÃ©rer lâ€™URL
      id: ngrok
      run: |
        ngrok http 5000 > /dev/null &
        echo "ğŸ•’ DÃ©marrage de Ngrok..."
        for i in {1..10}; do
          sleep 2
          TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[0-9a-z]*\.ngrok.io' | head -n 1)
          if [[ ! -z "$TUNNEL_URL" ]]; then
            echo "âœ… Ngrok prÃªt : $TUNNEL_URL"
            echo "url=$TUNNEL_URL" >> $GITHUB_OUTPUT
            break
          fi
        done
        if [[ -z "$TUNNEL_URL" ]]; then
          echo "âŒ Tunnel Ngrok non prÃªt"
          exit 1
        fi

    - name: Installer Pytest et lancer les tests
      run: |
        pip install pytest requests
        export API_URL=${{ steps.ngrok.outputs.url }}
        pytest tests/

    - name: Afficher lâ€™URL si les tests passent
      if: success()
      run: |
        echo "âœ… Tous les tests ont rÃ©ussi !"
        echo "ğŸ”— Lien d'accÃ¨s temporaire : ${{ steps.ngrok.outputs.url }}"

    - name: Ã‰chec des tests
      if: failure()
      run: |
        echo "âŒ Les tests ont Ã©chouÃ©. Aucune URL ne sera affichÃ©e."
